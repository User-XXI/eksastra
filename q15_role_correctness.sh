#!/usr/bin/env bash
set -euo pipefail

# Вопрос 15: Уровень ролевого управления доступом ОССН: условия корректности состояний; де-юре правила преобразования состояний

DEMO_MUTATE="${DEMO_MUTATE:-0}"
AUTO_ENTER="${AUTO_ENTER:-0}"
USE_SUDO="${USE_SUDO:-auto}"

bold(){ printf "\033[1m%s\033[0m" "$*"; }
dim(){  printf "\033[2m%s\033[0m" "$*"; }
cyan(){ printf "\033[36m%s\033[0m" "$*"; }
grn(){  printf "\033[32m%s\033[0m" "$*"; }
ylw(){  printf "\033[33m%s\033[0m" "$*"; }
hr(){ printf "%s\n" "$(dim '---------------------------------------------------------------------')"; }

pause(){
  [[ "$AUTO_ENTER" == "1" ]] && return 0
  echo
  read -r -p "$(dim 'Enter — дальше... ')" _
}

have(){ command -v "$1" >/dev/null 2>&1; }
need_sudo(){
  case "$USE_SUDO" in
    always) return 0 ;;
    never)  return 1 ;;
    auto)
      if [[ "$(id -u)" -ne 0 ]] && have sudo; then return 0; else return 1; fi
      ;;
  esac
}

run_cmd(){
  local cmd="$1"
  local why="${2:-}"
  echo
  [[ -n "$why" ]] && echo "$(bold 'Зачем:') $why"
  echo "$(cyan '$') $cmd"
  pause
  if need_sudo; then
    if [[ "$cmd" =~ ^sudo[[:space:]] ]]; then
      bash -lc "$cmd" 2>&1 || true
    else
      sudo bash -lc "$cmd" 2>&1 || bash -lc "$cmd" 2>&1 || true
    fi
  else
    bash -lc "$cmd" 2>&1 || true
  fi
}

title(){
  clear || true
  echo "$(bold 'Вопрос 15: Ролевое управление - корректность и правила преобразования')"
  hr
}

block_0_intro(){
  title
  echo "$(bold '0) Условия корректности состояний')"
  hr
  echo "Условия корректности ролевой модели:"
  echo "  1. Каждый пользователь имеет хотя бы одну роль"
  echo "  2. Роли имеют определённый набор прав"
  echo "  3. Права соответствуют политике безопасности"
  echo "  4. Сессии корректно привязаны к пользователям и ролям"
  echo "  5. Состояние системы согласовано"
  hr
  pause
}

block_1_state_correctness(){
  title
  echo "$(bold '1) Проверка корректности состояний')"
  hr
  
  run_cmd "id" "Проверка: пользователь имеет роли (группы)"
  
  run_cmd "groups" "Проверка: корректный набор ролей пользователя"
  
  run_cmd "getent passwd $(whoami)" "Проверка: пользователь существует и корректно определён"
  
  run_cmd "sudo -l 2>/dev/null | head -5 || echo 'Нет sudo ролей или не настроен'" \
    "Проверка: корректность назначенных sudo ролей"
  
  echo "$(bold 'Условия корректности:')"
  echo "  - Пользователь существует и имеет корректный UID"
  echo "  - Пользователь имеет хотя бы одну роль (группу)"
  echo "  - Роли существуют и имеют корректные GID"
  echo "  - Права ролей соответствуют политике"
  hr
}

block_2_role_integrity(){
  title
  echo "$(bold '2) Целостность ролевой структуры')"
  hr
  
  run_cmd "getent group | head -10" "Проверка: все роли существуют"
  
  run_cmd "for g in $(groups | tr ' ' '\n' | head -5); do echo \"=== \$g ===\"; getent group \"\$g\" || echo 'Роль не найдена'; done" \
    "Проверка: роли пользователя существуют"
  
  run_cmd "getent group root sudo admin wheel 2>/dev/null || echo 'Административные роли не найдены'" \
    "Проверка: критичные роли существуют"
  
  echo "$(bold 'Целостность ролевой структуры:')"
  echo "  - Все роли, на которые назначен пользователь, существуют"
  echo "  - Критичные роли (root, sudo) существуют"
  echo "  - Нет циклических зависимостей в иерархии ролей"
  hr
}

block_3_transformation_rules(){
  title
  echo "$(bold '3) Де-юре правила преобразования состояний')"
  hr
  echo "$(bold 'Правила преобразования состояний:')"
  echo "  1. Активация роли: пользователь может активировать роль, если она ему назначена"
  echo "  2. Деактивация роли: пользователь может деактивировать активную роль"
  echo "  3. Создание сессии: новая сессия создаётся при входе пользователя"
  echo "  4. Завершение сессии: сессия завершается при выходе пользователя"
  echo "  5. Изменение ролей: только администратор может изменять назначение ролей"
  hr
  
  run_cmd "who" "Текущие сессии (состояния пользователей)"
  
  run_cmd "sudo -V 2>/dev/null | head -5 || echo 'sudo недоступен'" \
    "Версия sudo (реализует правила преобразования состояний)"
  
  echo "$(bold 'Реализация в системе:')"
  echo "  - sudo: активация роли с правами"
  echo "  - su: переключение на другую роль"
  echo "  - login/logout: создание/завершение сессии"
  hr
}

block_4_session_transitions(){
  title
  echo "$(bold '4) Преобразования состояний сессий')"
  hr
  
  run_cmd "who -u" "Активные сессии с временем входа"
  
  run_cmd "w" "Детальная информация о сессиях"
  
  run_cmd "ps aux | grep -E '^$(whoami)' | head -5" \
    "Процессы в текущей сессии"
  
  echo "$(bold 'Преобразования состояний:')"
  echo "  - login: создание новой сессии (пользователь + роль)"
  echo "  - logout: завершение сессии (очистка состояния)"
  echo "  - sudo: активация роли в существующей сессии"
  echo "  - su: переключение роли (новая сессия или подсессия)"
  hr
  
  if have auditctl; then
    run_cmd "sudo ausearch -m user_login 2>/dev/null | tail -5 || echo 'События входа не найдены'" \
      "События создания сессий (аудит)"
  fi
}

block_5_role_assignment(){
  title
  echo "$(bold '5) Правила назначения ролей')"
  hr
  
  run_cmd "cat /etc/group | head -10" "Локальные роли (группы)"
  
  run_cmd "getent group | head -10" "Все роли (локальные + доменные)"
  
  echo "$(bold 'Правила назначения ролей:')"
  echo "  1. Только администратор может изменять назначение ролей"
  echo "  2. Пользователь не может сам себе добавить роль"
  echo "  3. Изменения должны соответствовать политике безопасности"
  echo "  4. Все изменения ролей аудируются"
  hr
  
  run_cmd "sudo -l 2>/dev/null | head -10 || echo 'Нет sudo прав'" \
    "Проверка: роли, которые может активировать пользователь"
  
  echo "$(ylw 'Примечание: Изменение ролей через usermod требует прав администратора')"
  hr
}

block_6_audit_transitions(){
  title
  echo "$(bold '6) Аудит преобразований состояний')"
  hr
  
  if have auditctl; then
    run_cmd "sudo auditctl -l 2>/dev/null | grep -E 'sudo|su|login|logout' | head -10 || echo 'Правила не найдены'" \
      "Правила аудита преобразований состояний"
    
    run_cmd "sudo ausearch -sc sudo 2>/dev/null | tail -5 || echo 'События sudo не найдены'" \
      "События активации ролей через sudo"
  fi
  
  run_cmd "journalctl -u auditd -n 30 --no-pager 2>/dev/null | grep -E 'sudo|su|login' | head -10 || echo 'События не найдены'" \
    "Логи преобразований состояний"
  
  echo "$(bold 'Аудит преобразований:')"
  echo "  - Фиксация создания/завершения сессий"
  echo "  - Логирование активации/деактивации ролей"
  echo "  - Отслеживание изменений назначения ролей"
  hr
}

block_7_consistency(){
  title
  echo "$(bold '7) Согласованность состояний системы')"
  hr
  
  run_cmd "id $(whoami)" "Текущее состояние: пользователь и роли"
  
  run_cmd "ps aux | grep -E '^$(whoami)' | wc -l" "Количество процессов пользователя (активность в сессии)"
  
  run_cmd "sudo -l 2>/dev/null | wc -l" "Количество доступных ролей через sudo"
  
  echo "$(bold 'Согласованность состояний:')"
  echo "  - Пользователь и его роли согласованы"
  echo "  - Активные сессии соответствуют пользователям"
  echo "  - Процессы принадлежат корректным пользователям и ролям"
  echo "  - Права доступа соответствуют активным ролям"
  hr
}

block_8_summary(){
  title
  echo "$(bold 'Итог: корректность и правила преобразования')"
  hr
  cat <<'EOF'
Условия корректности и правила преобразования:

1. Условия корректности состояний:
   - Пользователь имеет хотя бы одну роль
   - Роли существуют и имеют корректные права
   - Сессии привязаны к пользователям и ролям
   - Состояние системы согласовано

2. Де-юре правила преобразования:
   - Активация роли: пользователь может активировать назначенную роль
   - Деактивация роли: пользователь может деактивировать активную роль
   - Создание сессии: при входе пользователя
   - Завершение сессии: при выходе пользователя
   - Изменение ролей: только администратором

3. Преобразования состояний:
   - login: создание сессии
   - logout: завершение сессии
   - sudo/su: активация/переключение роли
   - Все преобразования аудируются

4. Согласованность:
   - Состояния пользователей и ролей согласованы
   - Активные сессии соответствуют пользователям
   - Процессы принадлежат корректным ролям
   - Права доступа соответствуют ролям

5. Реализация:
   - Linux группы как роли
   - sudo/su для активации ролей
   - Аудит всех преобразований
EOF
  hr
  pause
}

menu(){
  title
  echo "  0) Введение"
  echo "  1) Проверка корректности"
  echo "  2) Целостность ролевой структуры"
  echo "  3) Правила преобразования"
  echo "  4) Преобразования сессий"
  echo "  5) Правила назначения ролей"
  echo "  6) Аудит преобразований"
  echo "  7) Согласованность состояний"
  echo "  8) Итог"
  echo "  a) Всё по порядку"
  echo "  q) Выход"
  read -r -p "$(dim 'Выбор: ')" ch
  case "$ch" in
    0) block_0_intro ;;
    1) block_1_state_correctness ;;
    2) block_2_role_integrity ;;
    3) block_3_transformation_rules ;;
    4) block_4_session_transitions ;;
    5) block_5_role_assignment ;;
    6) block_6_audit_transitions ;;
    7) block_7_consistency ;;
    8) block_8_summary ;;
    a|A)
      block_0_intro
      block_1_state_correctness
      block_2_role_integrity
      block_3_transformation_rules
      block_4_session_transitions
      block_5_role_assignment
      block_6_audit_transitions
      block_7_consistency
      block_8_summary
      ;;
    q|Q) exit 0 ;;
    *) echo "$(ylw 'Не понял')"; pause ;;
  esac
}

while true; do
  menu
  pause
done

